

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Getting Started &mdash; CompilerGym 0.1.3 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="LLVM Environment Reference" href="llvm/index.html" />
    <link rel="prev" title="Indices and tables" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> CompilerGym
          

          
          </a>

          
            
            
              <div class="version">
                0.1.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#key-concepts">Key Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installation">Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#building-from-source">Building from Source</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#using-compilergym">Using CompilerGym</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#selecting-an-environment">Selecting an environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#installing-benchmarks">Installing benchmarks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-compiler-environment">The compiler environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#interacting-with-the-environment">Interacting with the environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-command-line-tools">Using the command line tools</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="llvm/index.html">LLVM Environment Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command Line Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption"><span class="caption-text">Python API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="compiler_gym/compiler_gym.html">compiler_gym</a></li>
<li class="toctree-l1"><a class="reference internal" href="compiler_gym/datasets.html">compiler_gym.datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="compiler_gym/envs.html">compiler_gym.envs</a></li>
<li class="toctree-l1"><a class="reference internal" href="llvm/api.html">compiler_gym.envs.llvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="compiler_gym/service.html">compiler_gym.service</a></li>
<li class="toctree-l1"><a class="reference internal" href="compiler_gym/spaces.html">compiler_gym.spaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="compiler_gym/views.html">compiler_gym.views</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">CompilerGym</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Getting Started</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/getting_started.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="getting-started">
<h1>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h1>
<a class="reference external image-reference" href="https://colab.research.google.com/github/facebookresearch/CompilerGym/blob/stable/examples/getting-started.ipynb"><img alt="https://colab.research.google.com/assets/colab-badge.svg" src="https://colab.research.google.com/assets/colab-badge.svg" /></a>
<p>CompilerGym is a toolkit for applying reinforcement learning to compiler
optimization tasks. This document provides a short walkthrough of the key
concepts, using the codesize reduction task of a production-grade compiler
as an example. It will take about 20 minutes to work through. Lets get
started!</p>
<div class="contents local topic" id="topics-covered">
<p class="topic-title">Topics covered:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#key-concepts" id="id3">Key Concepts</a></p></li>
<li><p><a class="reference internal" href="#installation" id="id4">Installation</a></p>
<ul>
<li><p><a class="reference internal" href="#building-from-source" id="id5">Building from Source</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#using-compilergym" id="id6">Using CompilerGym</a></p>
<ul>
<li><p><a class="reference internal" href="#selecting-an-environment" id="id7">Selecting an environment</a></p></li>
<li><p><a class="reference internal" href="#installing-benchmarks" id="id8">Installing benchmarks</a></p></li>
<li><p><a class="reference internal" href="#the-compiler-environment" id="id9">The compiler environment</a></p></li>
<li><p><a class="reference internal" href="#interacting-with-the-environment" id="id10">Interacting with the environment</a></p></li>
<li><p><a class="reference internal" href="#using-the-command-line-tools" id="id11">Using the command line tools</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="key-concepts">
<h2><a class="toc-backref" href="#id3">Key Concepts</a><a class="headerlink" href="#key-concepts" title="Permalink to this headline">¶</a></h2>
<p>CompilerGym exposes compiler optimization problems as environments for
reinforcement learning. It uses the <a class="reference external" href="https://gym.openai.com/">OpenAI Gym</a>
interface to expose the “agent-environment loop” of reinforcement learning:</p>
<img alt="_images/overview.png" src="_images/overview.png" />
<p>The ingredients for reinforcement learning that CompilerGym provides are:</p>
<ul class="simple">
<li><p><strong>Environment</strong>: a compiler optimization task. For example,
<em>optimizing a C++ graph-traversal program for codesize using LLVM</em>. The
environment encapsulates an instance of a compiler and a particular program
that is being compiled. As an agent interacts with the environment, the state
of the program, and the compiler, can change.</p></li>
<li><p><strong>Action Space</strong>: the actions that may be taken at the current environment
state. For example, this could be a set of optimization transformations that
the compiler can apply to the program.</p></li>
<li><p><strong>Observation</strong>: a view of the current environment state. For example, this
could be the Intermediate Representation (IR) of the program that is being
compiled. The types of observations that are available depend on the compiler.</p></li>
<li><p><strong>Reward</strong>: a metric indicating the quality of the previous action. For
example, for a codesize optimization task this could be the change to the
number of instructions of the previous action.</p></li>
</ul>
<p>A single instance of this “agent-environment loop” represents the compilation of
a particular program. The goal is to develop an agent that maximises the
cumulative reward from these environments so as to produce the best programs.</p>
</div>
<div class="section" id="installation">
<h2><a class="toc-backref" href="#id4">Installation</a><a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>Install the latest CompilerGym release using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pip install compiler_gym
</pre></div>
</div>
<p>The binary works on macOS and Linux (on Ubuntu 18.04, Fedora 28, Debian
10 or newer equivalents).</p>
<div class="section" id="building-from-source">
<h3><a class="toc-backref" href="#id5">Building from Source</a><a class="headerlink" href="#building-from-source" title="Permalink to this headline">¶</a></h3>
<p>If you prefer, you may build from source. This requires a modern C++
toolchain. On macOS you can use the system compiler. On linux, install
the required toolchain using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo apt install clang libtinfo5 patchelf
$ export CC=clang
$ export CXX=clang++
</pre></div>
</div>
<p>We recommend using
<a class="reference external" href="https://docs.conda.io/projects/conda/en/latest/user-guide/install/">conda</a>
to manage the remaining build dependencies. First create a conda
environment with the required dependencies:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ conda create -n compiler_gym python=3.8 bazel=3.1.0 cmake pandoc
$ conda activate compiler_gym
</pre></div>
</div>
<p>Then clone the CompilerGym source code using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone https://github.com/facebookresearch/CompilerGym.git
$ cd CompilerGym
</pre></div>
</div>
<p>Install the python development dependencies using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ make init
</pre></div>
</div>
<p>Then run the test suite to confirm that everything is working:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ make test
</pre></div>
</div>
<p>To build and install the python package, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ make install
</pre></div>
</div>
<p><strong>NOTE:</strong> To use the python code that is installed by <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code>
you must leave the root directory of this repository. Attempting to
import <code class="docutils literal notranslate"><span class="pre">compiler_gym</span></code> while in the root of this repository will cause
import errors.</p>
<p>When you are finished, you can deactivate and delete the conda
environment using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ conda deactivate
$ conda env remove -n compiler_gym
</pre></div>
</div>
</div>
</div>
<div class="section" id="using-compilergym">
<h2><a class="toc-backref" href="#id6">Using CompilerGym</a><a class="headerlink" href="#using-compilergym" title="Permalink to this headline">¶</a></h2>
<p>Begin by firing up a python interpreter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python
</pre></div>
</div>
<p>To start with we import the gym module and the CompilerGym environments:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">gym</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">compiler_gym</span>
</pre></div>
</div>
<p>Importing <code class="xref py py-mod docutils literal notranslate"><span class="pre">compiler_gym</span></code> automatically registers the compiler environments.</p>
<p>We can see what environments are available using:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">compiler_gym</span><span class="o">.</span><span class="n">COMPILER_GYM_ENVS</span>
<span class="go">[&#39;llvm-v0&#39;, &#39;llvm-ic-v0&#39;, &#39;llvm-autophase-ic-v0&#39;, &#39;llvm-ir-ic-v0&#39;]</span>
</pre></div>
</div>
<div class="section" id="selecting-an-environment">
<h3><a class="toc-backref" href="#id7">Selecting an environment</a><a class="headerlink" href="#selecting-an-environment" title="Permalink to this headline">¶</a></h3>
<p>CompilerGym environments are named using one of the following formats:</p>
<ol class="arabic simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">&lt;compiler&gt;-&lt;observation&gt;-&lt;reward&gt;-&lt;version&gt;</span></code></p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">&lt;compiler&gt;-&lt;reward&gt;-&lt;version&gt;</span></code></p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">&lt;compiler&gt;-&lt;version&gt;</span></code></p></li>
</ol>
<p>Where <code class="code docutils literal notranslate"><span class="pre">&lt;compiler&gt;</span></code> identifiers the compiler optimization task,
<code class="code docutils literal notranslate"><span class="pre">&lt;observation&gt;</span></code> is the default type of observations that are provided,
and <code class="code docutils literal notranslate"><span class="pre">&lt;reward&gt;</span></code> is the reward signal.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A key concept is that
CompilerGym environments enables <strong>lazy evaluation</strong> of observations and
reward signals. This makes the environment much more computationally
efficient for scenarios in which you do not need to compute a reward or
observation for every step. If an environment omits a <code class="code docutils literal notranslate"><span class="pre">&lt;observation&gt;</span></code>
or <code class="code docutils literal notranslate"><span class="pre">&lt;reward&gt;</span></code> tag, this means that no observation or reward is
provided by default. See <a class="reference internal" href="compiler_gym/views.html"><span class="doc">compiler_gym.views</span></a> for
further details.</p>
</div>
<p>For this tutorial, we will use the following environment:</p>
<ul class="simple">
<li><p><strong>Compiler</strong>: <a class="reference internal" href="llvm/index.html"><span class="doc">LLVM</span></a>.</p></li>
<li><p><strong>Observation Type</strong>: <a class="reference internal" href="llvm/index.html#autophase"><span class="std std-ref">Autophase</span></a>.</p></li>
<li><p><strong>Reward Signal</strong>: <a class="reference internal" href="llvm/index.html#codesize"><span class="std std-ref">IR Instruction count relative to -Oz</span></a>.</p></li>
</ul>
<p>Create an instance of this environment using:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;llvm-autophase-ic-v0&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="installing-benchmarks">
<h3><a class="toc-backref" href="#id8">Installing benchmarks</a><a class="headerlink" href="#installing-benchmarks" title="Permalink to this headline">¶</a></h3>
<p>A compiler requires a program as input. For the purposes of CompilerGym we call
these input programs <em>benchmarks</em>, and collections of benchmarks are assembled
into <em>datasets</em>. You may provide your own programs to use as benchmarks, or
download one of our pre-assembled datasets.</p>
<p>The benchmarks that are available to an environment can be queried using
<a class="reference internal" href="compiler_gym/envs.html#compiler_gym.envs.CompilerEnv.benchmarks" title="compiler_gym.envs.CompilerEnv.benchmarks"><code class="xref py py-attr docutils literal notranslate"><span class="pre">env.benchmarks</span></code></a>:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">benchmarks</span>
<span class="go">[]</span>
</pre></div>
</div>
<p>As you can see, there are no benchmarks installed by default. We have provided
a collection of pre-assembled
<a class="reference internal" href="llvm/index.html#datasets"><span class="std std-ref">LLVM benchmark datasets</span></a> that can be
installed using
<a class="reference internal" href="compiler_gym/envs.html#compiler_gym.envs.CompilerEnv.require_dataset" title="compiler_gym.envs.CompilerEnv.require_dataset"><code class="xref py py-meth docutils literal notranslate"><span class="pre">env.require_dataset()</span></code></a>.
For this tutorial we will use the
<a class="reference external" href="https://www.nas.nasa.gov/publications/npb.html">NAS Parallel Benchmarks</a>
dataset:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">require_dataset</span><span class="p">(</span><span class="s2">&quot;npb-v0&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, <a class="reference internal" href="compiler_gym/envs.html#compiler_gym.envs.CompilerEnv.benchmarks" title="compiler_gym.envs.CompilerEnv.benchmarks"><code class="xref py py-attr docutils literal notranslate"><span class="pre">env.benchmarks</span></code></a> lists
the 123 benchmarks that comprise the dataset we just installed:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">benchmarks</span>
<span class="go">[&#39;benchmark://npb-v0/46&#39;, &#39;benchmark://npb-v0/17&#39;, ...]</span>
</pre></div>
</div>
</div>
<div class="section" id="the-compiler-environment">
<h3><a class="toc-backref" href="#id9">The compiler environment</a><a class="headerlink" href="#the-compiler-environment" title="Permalink to this headline">¶</a></h3>
<p>If you have experience using <a class="reference external" href="https://gym.openai.com/">OpenAI Gym</a>, the
CompilerGym environments will be familiar. If not, you can call <code class="code docutils literal notranslate"><span class="pre">help()</span></code>
on any function, object, or method to query the documentation:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">help</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</pre></div>
</div>
<p>The action space is described by
<a class="reference internal" href="compiler_gym/envs.html#compiler_gym.envs.CompilerEnv.action_space" title="compiler_gym.envs.CompilerEnv.action_space"><code class="xref py py-meth docutils literal notranslate"><span class="pre">env.action_space</span></code></a>.
The <a class="reference internal" href="llvm/index.html#action-space"><span class="std std-ref">LLVM Action Space</span></a> is discrete:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">dtype</span>
<span class="go">dtype(&#39;int64&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">n</span>
<span class="go">138</span>
</pre></div>
</div>
<p>The observation space is described by
<a class="reference internal" href="compiler_gym/envs.html#compiler_gym.envs.CompilerEnv.observation_space" title="compiler_gym.envs.CompilerEnv.observation_space"><code class="xref py py-meth docutils literal notranslate"><span class="pre">env.observation_space</span></code></a>.
The <a class="reference internal" href="llvm/index.html#autophase"><span class="std std-ref">Autophase</span></a> observation space is a 56-dimension
vector of integers:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">observation_space</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(56,)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">observation_space</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">dtype</span>
<span class="go">dtype(&#39;int64&#39;)</span>
</pre></div>
</div>
<p>The upper and lower bounds of the reward signal are described by
<code class="xref py py-meth docutils literal notranslate"><span class="pre">env.reward_range</span></code>:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">reward_range</span>
<span class="go">(0.0, inf)</span>
</pre></div>
</div>
<p>As with other Gym environments,
<a class="reference internal" href="compiler_gym/envs.html#compiler_gym.envs.CompilerEnv.reset" title="compiler_gym.envs.CompilerEnv.reset"><code class="xref py py-meth docutils literal notranslate"><span class="pre">reset()</span></code></a>
must be called before a CompilerGym environment may be used:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="go">array([   0,    0,  399,  381,   10,  399,  147,    8,  137,  147,    0,</span>
<span class="go">          0,    0,  556,    0,  546,    0,   15,  693,  574, 1214, 1180,</span>
<span class="go">        384,  399,  214,    0,  120,  116,    0,   88,  468,    8,  546,</span>
<span class="go">         16, 1073,  147,    0, 1551,    0,    0,    0,   10,  766,    0,</span>
<span class="go">          0,  505,   46,    0,    0,    0,  556, 5075, 3261,   13,    0,</span>
<span class="go">       2441])</span>
</pre></div>
</div>
<p>The numpy array that is returned here is the initial
<a class="reference internal" href="llvm/index.html#autophase"><span class="std std-ref">Autophase</span></a> observation. Calling
<a class="reference internal" href="compiler_gym/envs.html#compiler_gym.envs.CompilerEnv.reset" title="compiler_gym.envs.CompilerEnv.reset"><code class="xref py py-meth docutils literal notranslate"><span class="pre">env.reset()</span></code></a> starts an
instance of the compiler and selects a random benchmark to use. You can see
which benchmark is currently being used by an environment using
<a class="reference internal" href="compiler_gym/envs.html#compiler_gym.envs.CompilerEnv.benchmark" title="compiler_gym.envs.CompilerEnv.benchmark"><code class="xref py py-attr docutils literal notranslate"><span class="pre">env.benchmark</span></code></a>:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">benchmark</span>
<span class="go">&#39;benchmark://npb-v0/90&#39;</span>
</pre></div>
</div>
<p>If we want to force the environment to use a specific benchmark, we can pass the
name of the benchmark as an argument to
<a class="reference internal" href="compiler_gym/envs.html#compiler_gym.envs.CompilerEnv.reset" title="compiler_gym.envs.CompilerEnv.reset"><code class="xref py py-meth docutils literal notranslate"><span class="pre">env.reset()</span></code></a>:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">benchmark</span><span class="o">=</span><span class="s2">&quot;benchmark://npb-v0/50&quot;</span><span class="p">)</span>
<span class="go">array([   0,    0,   26,   25,    1,   26,   10,    1,    8,   10,    0,</span>
<span class="go">          0,    0,   37,    0,   36,    0,    2,   46,  175, 1664, 1212,</span>
<span class="go">        263,   26,  193,    0,   59,    6,    0,    3,   32,    0,   36,</span>
<span class="go">         10, 1058,   10,    0,  840,    0,    0,    0,    1,  416,    0,</span>
<span class="go">          0,  148,   60,    0,    0,    0,   37, 3008, 2062,    9,    0,</span>
<span class="go">       1262])</span>
</pre></div>
</div>
</div>
<div class="section" id="interacting-with-the-environment">
<h3><a class="toc-backref" href="#id10">Interacting with the environment</a><a class="headerlink" href="#interacting-with-the-environment" title="Permalink to this headline">¶</a></h3>
<p>Once an environment has been initialized, you interact with it in the same way
that you would with any other <a class="reference external" href="https://gym.openai.com/">OpenAI Gym</a>
environment. <a class="reference internal" href="compiler_gym/envs.html#compiler_gym.envs.LlvmEnv.render" title="compiler_gym.envs.LlvmEnv.render"><code class="xref py py-meth docutils literal notranslate"><span class="pre">env.render()</span></code></a> prints
the Intermediate Representation (IR) of the program in the current state:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
<span class="go">; ModuleID = &#39;benchmark://npb-v0/83&#39;</span>
<span class="go">target datalayout = &quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span>
<span class="go">target triple = &quot;x86_64-pc-linux-gnu&quot;</span>
<span class="gp">...</span>
</pre></div>
</div>
<p><a class="reference internal" href="compiler_gym/envs.html#compiler_gym.envs.CompilerEnv.step" title="compiler_gym.envs.CompilerEnv.step"><code class="xref py py-meth docutils literal notranslate"><span class="pre">env.step()</span></code></a> runs an action:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>This returns four values: a new observation, a reward, a boolean value
indicating whether the episode has ended, and a dictionary of additional
information:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">observation</span>
<span class="go">array([   0,    0,   26,   25,    1,   26,   10,    1,    8,   10,    0,</span>
<span class="go">          0,    0,   37,    0,   36,    0,    2,   46,  175, 1664, 1212,</span>
<span class="go">        263,   26,  193,    0,   59,    6,    0,    3,   32,    0,   36,</span>
<span class="go">         10, 1058,   10,    0,  840,    0,    0,    0,    1,  416,    0,</span>
<span class="go">          0,  148,   60,    0,    0,    0,   37, 3008, 2062,    9,    0,</span>
<span class="go">       1262])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">reward</span>
<span class="go">0.3151595744680851</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">done</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">info</span>
<span class="go">{&#39;action_had_no_effect&#39;: True, &#39;new_action_space&#39;: False}</span>
</pre></div>
</div>
<p>For this environment, reward represents the reduction in code size of the
previous action, scaled to the total codesize reduction achieved with LLVM’s
<code class="code docutils literal notranslate"><span class="pre">-Oz</span></code> optimizations enabled. A cumulative reward greater than one means
that the sequence of optimizations performed yields better results than LLVM’s
default optimizations. Let’s run 100 random actions and see how close we can
get:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">benchmark</span><span class="o">=</span><span class="s2">&quot;benchmark://npb-v0/50&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">episode_reward</span> <span class="o">=</span> <span class="mi">0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">sample</span><span class="p">())</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">break</span>
<span class="gp">... </span>    <span class="n">episode_reward</span> <span class="o">+=</span> <span class="n">reward</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, quality=</span><span class="si">{</span><span class="n">episode_reward</span><span class="si">:</span><span class="s2">.3%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Step 1, quality=44.299%</span>
<span class="go">Step 2, quality=44.299%</span>
<span class="go">Step 3, quality=44.299%</span>
<span class="go">Step 4, quality=44.299%</span>
<span class="go">Step 5, quality=44.299%</span>
<span class="go">Step 6, quality=54.671%</span>
<span class="go">Step 7, quality=54.671%</span>
<span class="go">Step 8, quality=54.608%</span>
<span class="go">Step 9, quality=54.608%</span>
<span class="go">Step 10, quality=54.608%</span>
<span class="go">Step 11, quality=54.608%</span>
<span class="go">Step 12, quality=54.766%</span>
<span class="go">Step 13, quality=54.766%</span>
<span class="go">Step 14, quality=53.650%</span>
<span class="go">Step 15, quality=53.650%</span>
<span class="gp">...</span>
<span class="go">Step 97, quality=88.104%</span>
<span class="go">Step 98, quality=88.104%</span>
<span class="go">Step 99, quality=88.104%</span>
<span class="go">Step 100, quality=88.104%</span>
</pre></div>
</div>
<p>Not bad, but clearly there is room for improvement! Because at each step we are
taking random actions, your results will differ with every run. Try running it
again. Was the result better or worse? Of course, there may be better ways of
selecting actions than choosing randomly, but for the purpose of this tutorial
we will leave that as an exercise for the reader :)</p>
<p>Before we finish, lets use
<a class="reference internal" href="compiler_gym/envs.html#compiler_gym.envs.CompilerEnv.commandline" title="compiler_gym.envs.CompilerEnv.commandline"><code class="xref py py-meth docutils literal notranslate"><span class="pre">env.commandline()</span></code></a>
to produce an LLVM <code class="code docutils literal notranslate"><span class="pre">opt</span></code> command line invocation that is equivalent to
the sequence of actions we just run:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">commandline</span><span class="p">()</span>
<span class="go">&#39;opt -consthoist -sancov -inferattrs ... -place-safepoints input.bc -o output.bc&#39;</span>
</pre></div>
</div>
<p>We can also save the program for future reference:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">write_bitcode</span><span class="p">(</span><span class="s2">&quot;~/program.bc&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Once we are finished, we must close the environment to end the compiler
instance:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">env</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>And finally we are done with our python session:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">exit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="using-the-command-line-tools">
<h3><a class="toc-backref" href="#id11">Using the command line tools</a><a class="headerlink" href="#using-the-command-line-tools" title="Permalink to this headline">¶</a></h3>
<p>CompilerGym includes a set of useful <a class="reference internal" href="cli.html"><span class="doc">command line tools</span></a>. Each of
the steps above could be replicated from the command line.</p>
<p>For example, <a class="reference internal" href="cli.html#module-compiler_gym.bin.service" title="compiler_gym.bin.service"><code class="xref py py-mod docutils literal notranslate"><span class="pre">compiler_gym.bin.service</span></code></a> can be used to list the available
environments:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python -m compiler_gym.bin.service --ls_env
llvm-v0
...
</pre></div>
</div>
<p>And to describe the capabilities of each environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python -m compiler_gym.bin.service --env=llvm-v0
# CompilerGym Service `/path/to/compiler_gym/envs/llvm/service/compiler_gym-llvm-service`

## Programs

+------------------------+
| Benchmark              |
+========================+
| benchmark://npb-v0/1   |
+------------------------+

...

## Action Spaces


### `PassesAll` (Commandline)

+---------------------------------------+-----------------------------------+-------------------------------+
| Action                                | Flag                              | Description                   |
+=======================================+===================================+===============================+
| AddDiscriminatorsPass                 | `-add-discriminators`             | Add DWARF path discriminators |
+---------------------------------------+-----------------------------------+-------------------------------+
...
</pre></div>
</div>
<p>The <a class="reference internal" href="cli.html#module-compiler_gym.bin.manual_env" title="compiler_gym.bin.manual_env"><code class="xref py py-mod docutils literal notranslate"><span class="pre">compiler_gym.bin.manual_env</span></code></a> module provides a thin text user
interface around the environment for interactive sessions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python -m compiler_gym.bin.manual_env --env=llvm-autophase-ic-v0 --benchmark=npb-v0/50
Initialized environment in 264.9ms
Reset benchmark://npb-v0/50 environment in 27.6ms
Observation: [  0   0  11  10   1  11   5   1   3   5   0   0   0  17   0  16   0   2
  21  20  50  44  18  11   6   0   3  10   0   1  16   0  16   2  40   5
   0  59   0   0   0   1  30   0   0  18   0   0   0   0  17 193 129   4
   0  99]
</pre></div>
</div>
<p>Finally, the <a class="reference internal" href="cli.html#module-compiler_gym.bin.random_search" title="compiler_gym.bin.random_search"><code class="xref py py-mod docutils literal notranslate"><span class="pre">compiler_gym.bin.random_search</span></code></a> module provides a simple
but powerful strategy for randomly searching the optimization space:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python -m compiler_gym.bin.random_search --env=llvm-autophase-ic-v0 --benchmark=npb-v0/50 --runtime=10

Started 16 worker threads for benchmark://npb-v0/50 (3,008 instructions) using reward IrInstructionCountOz.
Writing logs to /home/user/logs/compiler_gym/random/npb-v0/50/2020-12-03T17:24:17.304887
=== Running for 10 seconds ===
Runtime: 10 seconds. Num steps: 32,287 (3,206 / sec). Num episodes: 285 (28 / sec). Num restarts: 0.
Best reward: 107.85% (69 passes, found after 9 seconds)

Ending worker threads ... done
Replaying actions from best solution found:
Step [000 / 069]: reward=31.52%
Step [001 / 069]: reward=31.52%, change=0.00%, action=SlpvectorizerPass
Step [002 / 069]: reward=37.09%, change=5.57%, action=Sroapass
...
Step [067 / 069]: reward=107.60%, change=0.00%, action=InductiveRangeCheckEliminationPass
Step [068 / 069]: reward=107.60%, change=0.00%, action=LoopDeletionPass
Step [069 / 069]: reward=107.85%, change=0.24%, action=Gvnpass
</pre></div>
</div>
<p>To beat the compiler by 7.85% after 10 seconds of random trials is not bad
going!</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="llvm/index.html" class="btn btn-neutral float-right" title="LLVM Environment Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Indices and tables" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright Facebook AI Research

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'G-T95G5EVYXM', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>